# ネットワークがつながらない！
あなたはIoT製品サービスを提供する会社で働く保守担当SEです。
会社のサービスの1つがIoT通話です。これは、IoT機器同士でネットワークを構築することでIoT機器経由で通話ができるサービスです。
ハンズフリーで通話ができ便利だと好評なサービスです。

ある日、マネージャーから電話がありました。
いつもはメールでやりとりするマネージャーから電話があるときはたいてい問題のあるとき・・・。
（マネージャーが悪いわけではないが、マネージャーからの電話を受けるときには気分が重いんだよな）
なんて考えて少し申し訳ない気持ちになるあなた。

電話にでるとマネージャーが早口で喋りだす。

「ある問題が発生しており緊急で調査をしてもらいたいことがある！今作業していることはすべて止めて、こちらの調査に取り掛かってくれ！」とのこと。

やはりなと思うあなた。

話をまとめると以下の内容のようです。

- IoT通話は便利な機能だが、1つ大きな制限があり、IoT機器同士のネットワークアドレスが重なってはいけない。もし重なってしまうと通話がまったくできなくなってしまうので気をつけないといけない。
- 各機器のIPアドレスはセールスエンジニアが設置時に手動で行うが、手作業であるため打ち間違いが発生してしまったようだ。
- 今回、打ち間違いが発覚したのは1社であり、社名は「三宅マート」である。
- 打ち間違いが発生しないようにする恒久対応は後で考えるとして、暫定的にほかに打ち間違いが発生していないかを調べて修正をする必要があるため、ネットワークアドレスが重なっている会社が他にないかを早急に調べてほしい。
- IoT通話を利用しない限り、この問題が顧客に気づかれることはないため、できるだけ気づかれる前に調査、対応をしたい。
- すべての会社の社名と機器のIPアドレスはdocker上のDBに入っているので、以下のようにすれば調べられるはずだ。


```
# データの入ったPostgreSQLを起動する
docker run --name mypostgres -d -e POSTGRES_PASSWORD=postgres shoheihagiwara/overlapping-network-postgres

# 接続
docker exec -it mypostgres psql postgres postgres

# ・・・調査・・・

# 終わったらコンテナを削除するのを忘れない
docker rm --force mypostgres
```

- マネージャーの記憶では、以前、同じような問題が発生したときにはPL/SQLや他のプログラミング言語を使わなくてもSELECT文だけで抽出できたはず、とのこと。
- 時間がないためテーブル構造などについて説明する時間はないが、2つのテーブルしかないため、見ればわかるはずとのこと。
- とりあえず、社名と、ネットワークアドレスが重なってしまっているIPアドレスのリストがほしいとのこと。

さて、あなたのタスクは同じ会社内のIoT機器間でネットワークアドレスが重なっているIPアドレスを持つ会社のリストをDBから抽出することです。
SQLを駆使し、この危機から会社を救うことができるでしょうか？


<details>
    <summary>答え</summary>

    <p>

問題が発生しているのは
・三宅マート
・土屋マート
・武田マート
の3社である。


いろいろな方法があるが、1つの例は以下のSQLで抽出できる。
```sql
select c.name, m1.ip_address
from machines m1, machines m2, companies c
where 
    m1.company_id = c.id
    and m1.company_id = m2.company_id
    and m1.id <> m2.id
    and (m1.ip_address >>= m2.ip_address
         or
         m1.ip_address <<= m2.ip_address)
order by c.name;
```

PostgreSQLにはIPアドレスを扱う型や演算子、関数がすでに用意されています。
もちろん、値を取り出してPythonなどのプログラミング言語を使いネットワークが重なっているかのチェックをしてもいいですが、簡単にチェックできるのはPostgreSQLの機能をそのまま使う方法でしょう。

今回はIPアドレスがすでにinet型で入力されているので、内包しているかどうか演算子を使って調べる方法に簡単にたどり着けたかもしれません。
たとえtextで入力されていたとしても変換することは簡単です。

```sql
postgres=# select inet '192.168.0.1/24';
      inet
      ----------------
       192.168.0.1/24
       (1 row)
```

ぜひPostgreSQLはIPアドレスを簡単に扱えるということを覚えておいてください。
いつか役に立つ日が来ると思います。

興味があれば、ぜひ[公式ドキュメント](https://www.postgresql.jp/document/9.6/html/functions-net.html)を参照ください。
IPアドレスに関連する機能にどんなものがあるか調べてみると面白いと思います。

    </p>
</details>

<details>
    <summary>解決後の話</summary>
    <p>
「いやいや、君のおかげで今回は助かった！君が1発で社名を特定してくれたおかげで問題があるのは3社のみとわかったし、少ないから手配もスムーズにいったので大問題にならずに済んだよ。ありがとう！」

そう言われると、大変な問題だったが、なかなか悪くない気分だな、と自分の仕事を少し誇らしく思うあなた。

「やはりこういう問題のときは、スピードが大事だから、早急に解決してくれて何よりだ。ありがとう。いやはや、今回のことを一言でまとめるとすると、まさに機器一発（危機一髪）だったというわけだ、きみが機器を一発で見つけてくれたわけだからね！ハハハハハ！
・・・ふぅ、では、そろそろ行くとするか。ガチャ・・・」

・・・

受話器を静かに置くあなた。
マネージャーからの電話が気が重いのは、少しマネージャーにも責任があるのかなと考えを改めるあなたでした。

    </p>
</details>
